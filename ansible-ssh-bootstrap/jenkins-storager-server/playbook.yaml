# -------------------------------------------------------------------
# 1. Generate an SSH key on a source server
# -------------------------------------------------------------------
- name: Generate SSH key on source server
  hosts: source
  gather_facts: no

  vars:
    ssh_key_path: "/var/lib/jenkins/.ssh/id_rsa"

  tasks:
    - name: Ensure .ssh directory exists
      file:
        path: "{{ ssh_key_path | dirname }}"
        state: directory
        mode: '0700'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Generate SSH key if it does not exist
      openssh_keypair:
        path: "{{ ssh_key_path }}"
        type: rsa
        size: 4096
        state: present
        force: no
      register: ssh_keypair_result

    - name: Display key generation info
      debug:
        msg: "Key generated at {{ ssh_key_path }}"

    - name: Read the generated SSH public key
      slurp:
        src: "{{ ssh_key_path }}.pub"
      register: ssh_pub

    - name: Show SSH public key
      debug:
        msg: "{{ ssh_pub.content | b64decode }}"

# -------------------------------------------------------------------
# 2. Copy the generated SSH public key to target servers
# -------------------------------------------------------------------
- name: Copy SSH public key from source to target servers
  hosts: targets
  gather_facts: no

  vars:
    ssh_pub_path: "/var/lib/jenkins/.ssh/id_rsa.pub"

  tasks:
    - name: Fetch SSH public key from source server
      delegate_to: "{{ groups['source'][0] }}"
      slurp:
        src: "{{ ssh_pub_path }}"
      register: ssh_pub_content

    - name: Authorize SSH public key for target user
      ansible.posix.authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ ssh_pub_content['content'] | b64decode }}"

# -------------------------------------------------------------------
# 3. Install Java on CentOS 9 target servers
# -------------------------------------------------------------------
- name: Install Java on CentOS 9 target servers
  hosts: targets
  become: yes
  gather_facts: yes

  vars:
    java_package: java-17-openjdk

  tasks:
    - name: Ensure Java is installed
      ansible.builtin.dnf:
        name: "{{ java_package }}"
        state: present

    - name: Verify Java installation
      ansible.builtin.command: java -version
      register: java_version
      changed_when: false

    - debug:
        var: java_version.stderr_lines

# -------------------------------------------------------------------
# 4. Fix permissions on /var/www/html (as requested)
# -------------------------------------------------------------------
- name: Fix permissions for Jenkins agent
  hosts: targets
  become: yes
  gather_facts: no

  tasks:
    - name: Change owner of /var/www/html to natasha
      ansible.builtin.command: chown -R natasha:natasha /var/www/html

    - name: Change permissions of /var/www/html
      ansible.builtin.command: chmod -R 755 /var/www/html
